# Routing 이해하기

-   Elasticsearch는 어떻게 document를 저장할 위치를 알고 있는가?
-   색인화된 문서는 어떻게 한 번에 찾을 수 있는가?
    -   retrieve
    -   update
    -   delete

위의 해답에는 `라우팅`이라고 대답할 수 있다.

## 라우팅

-   라우팅은 문서의 샤드를 확인하는 과정이다.
    > shard_num = hash(\_routing) % num_primary_shards
    > \_routing이 무엇인지는 곧 다시 설명할 것인데 일단 `_routing = document ID`라고 알아두자

## 커스텀 라우팅

-   Routing은 Elasticsearch를 사용할 때 100% 투명하다.
    -   그래서 Elasticsearch를 배우거나 사용하기 쉽다.
-   그러나 라우팅은 다양한 용도로 커스터마이징할 수 있다.
    -   이것은 매우 복잡하니 다음에
-   기본 라우팅 전략을 사용하면 document가 고르게 분산된다.

## 샤드의 수를 변경할 수 없는 이유

-   인덱스가 만들어진 이후에는 샤드의 수를 변경할 수 없다는 것을 기억하는가?
    -   경로 공식을 보게 되면 이유를 알 수 있다.
    -   왜냐하면 샤드의 수는 공식 내에서 사용되기 때문이다.
        > shard_num = hash(\_routing) % (primary 샤드의 수)
    -   인덱스의 샤드 수를 변경하면 라우팅 공식이 다른 결과를 얻을 수 있어 해시의 고윳값이 깨지게 됨.

## 샤드 수는 정말 변경할 수 없을까?

-   샤드 수를 수정하려면 새 색인을 작성하고 문서에 다시 색인화 작업을 거쳐야 한다.
    -   Shrink 및 Split APIs를 사용하면 매우 쉽다.
